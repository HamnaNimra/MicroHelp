name: Build iOS IPA

on:
  push:
    branches:
      - engage_widgets
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable' # More reliable than hardcoded 3.38.9

    - name: Get Flutter Dependencies
      run: |
        flutter precache --ios
        flutter pub get

    - name: Repair iOS Toolchain
      run: |
        # 1. Clear the Windows-generated folder
        rm -rf ios

        # 2. Recreate iOS folder on the Mac runner
        flutter create . --platforms=ios

        # 3. Restore Config Files
        # Make sure these files are actually in 'ios_config/' in your GitHub repo!
        if [ -d "ios_config" ]; then
          cp ios_config/GoogleService-Info.plist ios/Runner/ 2>/dev/null || echo "No GoogleService-Info found"
          cp ios_config/Info.plist ios/Runner/ 2>/dev/null || echo "No Info.plist found"
        fi

        # 4. Force Deployment Target to 15.0 (Robust sed)
        # This looks for any line starting with # platform and replaces it
        sed -i '' "s/^# platform :ios, .*/platform :ios, '15.0'/" ios/Podfile

        # 5. Build the bridge and install Pods
        # Running 'flutter build ios --config-only' ensures the plugin registrant is created
        flutter build ios --config-only --no-codesign
        cd ios
        pod install --repo-update
        cd ..

    - name: Build IPA
      run: flutter build ipa --no-codesign

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: build/ios/ipa/*.ipa
